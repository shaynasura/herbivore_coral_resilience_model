---
title: "Resilience_Supplement_Figures"
output: pdf_document
---


```{r setup, include=FALSE}

# library(deSolve)
# library(ggplot2)
# library(reshape2)
# library(viridis)
# library(gridExtra)
# library(gtable)
# library(grid)
# library(lemon)

library(deSolve)
library(ggplot2)
library(reshape2)
library(viridis)
library(viridisLite)
library(colorspace)
library(gridExtra)
library(gtable)
library(grid)
library(lemon)


```

## Basic Model Set up

To add a new chunk of R code, do option+command+i
```{r Basic Model,echo=TRUE}

#Set initial conditions for state variables
H0<-0.9
C0<-0.75
A0<-0.1
S0 <- 1 - C0 - A0

state_vars<-c(HH=H0, CC=C0, AA=A0, SS=S0)

#generate a series of times at which you want the ODE solver to output population sizes
tseq<-seq(0,1000,by=0.1)

#Generate a vector of parameter values
pars<-c(bc<-0.3,
        ba<- 0.8,
        ic<-0.05,
        ia<-0.05,
        dc<-0.1,
        r<-1,
        g<-1,
        eta<-1,
        alpha<-0.5,
        sigma<-0.6,
        f<-0.1)

Basic_Model<-function(tseq,state_vars,pars){
  HH <- state_vars[1]
  CC <- state_vars[2]
  AA <- state_vars[3]
  SS <- 1 - CC - AA
  
  bc <- pars[1]
  ba <- pars[2]
  ic <- pars[3]
  ia <- pars[4]
  dc <- pars[5]
  r <- pars[6]
  g <- pars[7]
  eta <- pars[8]
  alpha <- pars[9]
  sigma <- pars[10]
  f <- pars[11]
  
  dC_dt <- (ic + bc*CC)*SS*(1-alpha*AA)- dc*CC
  dA_dt <-(ia + ba*AA)*SS - (g*HH*AA / (g*eta*AA+1))
  dH_dt <-r*HH*(1 - (HH / ((1-sigma) + sigma*CC))) - f*HH

  return(list(c(dH<- dH_dt,
                dC <- dC_dt,
                dA <- dA_dt)))
}

Basic_M_output<-lsoda(c(Herbivores=H0,Coral=C0,Algae=A0), tseq, Basic_Model, pars)
Basic_M_output=as.data.frame(Basic_M_output)
Basic_M_output$Space= 1 - Basic_M_output$Coral - Basic_M_output$Algae

#head(Basic_M_output)
#tail(Basic_M_output)

```


## Basic Model: Hysteresis Plot - Figure S1

```{r Hysteresis Plots similar to Ranjan's}

#Set up a for loop to run lsoda for each fishing pressure
#BUT need to start each new run with where the system ENDED after the last run / loop

f_values<-seq(0,1,by=0.005)
tseq<-seq(0,1000,by=0.1)

## set up a data frame to store the results I want
Hysteresis_output<-data.frame(f_values)

# Set up for loop to run lsoda with different initial conditions & different fishing pressures
for(i in 1:length(f_values)){
  if(i==1){
    H0<-0.9
    C0<-0.75
    A0<-0.1
    S0<-0.15
    }
  else{
    H0<-tail(hh_output_new$Herbivores,1)
    C0<-tail(hh_output_new$Coral,1)
    A0<-tail(hh_output_new$Algae,1)
    S0<-tail(hh_output_new$Space,1)
  }
  state_vars<-c(HH=H0, CC=C0, AA=A0, SS=S0)
  pars[11]<-f_values[i] # set fishing pressure
  hh_output<-lsoda(c(Herbivores=H0,Coral=C0,Algae=A0), tseq, Basic_Model, pars)
  hh_output_new<-as.data.frame(hh_output)
  hh_output_new$Space= 1 - hh_output_new$Coral - hh_output_new$Algae
  
  Hysteresis_output$Fishing[i]<-pars[11]
  Hysteresis_output$Initial_Coral[i]<-C0
  Hysteresis_output$Final_Coral[i]<-tail(hh_output_new$Coral,1)
  Hysteresis_output$Final_Algae[i]<-tail(hh_output_new$Algae,1)
  Hysteresis_output$Final_Herbivores[i]<-tail(hh_output_new$Herbivores,1)
  Hysteresis_output$Final_Space[i]<-tail(hh_output_new$Space,1)
}


```


## Plotting the Hysteresis Figure

```{r}

#quartz()
par(mfrow=c(1,2))
plot(Hysteresis_output$Fishing, Hysteresis_output$Final_Coral,
     type = "l",
     col = "red",
     lwd=4,
     xlab="Fishing Pressure",
     ylab="Cover / Abundance",
     ylim=c(0,1),
     xlim=c(0,1),
     cex.lab=1,
     cex.axis=1.5,
#     main = "Fishing Pressure = 0.1",
     cex.main=2)
lines(Hysteresis_output$Fishing, Hysteresis_output$Final_Algae, col="green", lwd=4)
lines(Hysteresis_output$Fishing, Hysteresis_output$Final_Herbivores, col="blue", lwd=4)
legend("topright",
       c("Herbivores","Algae","Coral"),
       lty=1,
       lwd=4,
       col=c("blue","green","red"),
       cex=2)


```


## Reversing the Simulation

```{r Reversing the Hysteresis Simulation}

f_values_2<-rev(seq(0,1,by=0.005))
tseq<-seq(0,1000,by=0.1)

## set up a data frame to store the results I want
Hysteresis_output_2<-data.frame(f_values_2)

# Set up for loop to run lsoda with different initial conditions & different fishing pressures
for(i in 1:length(f_values_2)){
  if(i==1){
    H0<-tail(Hysteresis_output$Final_Herbivores,1)
    C0<-tail(Hysteresis_output$Final_Coral,1)
    A0<-tail(Hysteresis_output$Final_Algae,1)
    S0<-tail(Hysteresis_output$Final_Space,1)
    
    # H0<-0.9
    # C0<-0.75
    # A0<-0.1
    # S0<-0.15
    
    }
  else{
    H0<-tail(hh_output_new2$Herbivores,1)
    C0<-tail(hh_output_new2$Coral,1)
    A0<-tail(hh_output_new2$Algae,1)
    S0<-tail(hh_output_new2$Space,1)
  }
  state_vars<-c(HH=H0, CC=C0, AA=A0, SS=S0)
  pars[11]<-f_values_2[i] # set fishing pressure
  hh_output_2<-lsoda(c(Herbivores=H0,Coral=C0,Algae=A0), tseq, Basic_Model, pars)
  hh_output_new2<-as.data.frame(hh_output_2)
  hh_output_new2$Space= 1 - hh_output_new2$Coral - hh_output_new2$Algae
  
  Hysteresis_output_2$Fishing[i]<-pars[11]
  Hysteresis_output_2$Initial_Coral[i]<-C0
  Hysteresis_output_2$Final_Coral[i]<-tail(hh_output_new2$Coral,1)
  Hysteresis_output_2$Final_Algae[i]<-tail(hh_output_new2$Algae,1)
  Hysteresis_output_2$Final_Herbivores[i]<-tail(hh_output_new2$Herbivores,1)
  Hysteresis_output_2$Final_Space[i]<-tail(hh_output_new$Space,1)
}


```




## Plotting the Hysteresis Figure with forward and backward run

```{r}

# Trying to figure out which points to pull out as the tipping points...July 17, 2019
quartz()
plot(Hysteresis_output$Fishing, Hysteresis_output$Final_Coral,
     pch=15,
     xlim = c(0,1),
     ylim = c(0,1),
     xlab="Fishing Pressure",
     ylab="Final Coral Cover")
points(Hysteresis_output_2$Fishing, Hysteresis_output_2$Final_Coral, col="pink", pch=15)
legend("topright",
       c("Forward","Reverse"),
       pch=15,
       col=c("black","pink"),
       cex=2)


# Calculate the difference in Final Coral cover between successive fishing pressures....then pull out the points with large jumps...
# Forward simulation
Basic_Final_Cover_Differences<-data.frame(Hysteresis_output$Fishing)
for(i in 1:(length(Hysteresis_output$Final_Coral)-1)){
  Basic_Final_Cover_Differences$Coral_Change[i]<-Hysteresis_output$Final_Coral[i+1] - Hysteresis_output$Final_Coral[i]
}
# view it (Basic_Final_Cover_Differences)

length(which(Basic_Final_Cover_Differences$Coral_Change< -0.05))
min(Basic_Final_Cover_Differences$Coral_Change)
## April 12, 2021 - when I view the "Differences" values, the point I think I want to use for starting the dotted line is when
##  fishing pressure = 0.515 for the forward simulation
## May 4, 2021 - when I increase the timesteps and view the "Differences" values again, it looks like the point shifted a litte
##  I think the point I want to use for starting the dotted line is when fishing pressure = 0.510


# Calculate the difference in Final Coral cover between successive fishing pressures for the reverse simulation
Basic_Final_Cover_Differences_2<-data.frame(Hysteresis_output_2$Fishing)
for(i in 1:(length(Hysteresis_output_2$Final_Coral)-1)){
  Basic_Final_Cover_Differences_2$Coral_Change[i]<-Hysteresis_output_2$Final_Coral[i+1] - Hysteresis_output_2$Final_Coral[i]
}
# view it Basic_Final_Cover_Differences_2

## April 12, 2021 - when I view the "Differences_2" values, the point I think I want to use for starting the dotted line is when
##   fishing pressure = 0.325 for the reverse simulation
## May 4, 2021 - when I increase the timesteps and view the "Differences_2" values again, it looks like the point shifted a litte
##  I think the point I want to use for starting the dotted line is when fishing pressure = 0.330 for the reverse simulation


## subset time points at which to actually plot output....
# coral_forward_connect<-subset(Hysteresis_output,Hysteresis_output$Fishing==0.515)
# coral_backward_connect<-subset(Hysteresis_output_2,Hysteresis_output_2$Fishing==0.325)
coral_forward_connect<-subset(Hysteresis_output,Hysteresis_output$Fishing==0.510)
coral_backward_connect<-subset(Hysteresis_output_2,Hysteresis_output_2$Fishing==0.330)
colnames(coral_backward_connect)<-c("f_values","Fishing","Initial_Coral","Final_Coral","Final_Algae","Final_Herbivores","Final_Space")
coral_connect<-rbind(coral_forward_connect,coral_backward_connect)



##Figure File: Basic_Hysteresis_FigS1

pdf("Basic_Hysteresis_FigS1_v2.pdf",height=6, width=7)

#quartz()
# plot(Hysteresis_output$Fishing[1:104],Hysteresis_output$Final_Coral[1:104],
plot(Hysteresis_output$Fishing[1:103],Hysteresis_output$Final_Coral[1:103],
     type = "l",
     col = "red",
     lwd=6,
     xlab="Fishing Pressure",
     ylab="",
     ylim=c(0,1),
     xlim=c(0,1),
     cex.lab=1.75,
     cex.axis=1.4,
     cex.main=1)

title(ylab="Cover / Abundance", mgp=c(2.5,1,0), cex.lab=1.75)
# lines(Hysteresis_output_2$Fishing[1:136], Hysteresis_output_2$Final_Coral[1:136], col="red", lwd=6)
lines(Hysteresis_output_2$Fishing[1:135], Hysteresis_output_2$Final_Coral[1:135], col="red", lwd=6)
lines(coral_connect$Fishing,coral_connect$Final_Coral, lty = 2, col="red", lwd=6)

# lines(Hysteresis_output$Fishing[1:104], Hysteresis_output$Final_Algae[1:104], col="green", lwd=6)
# lines(Hysteresis_output_2$Fishing[1:136], Hysteresis_output_2$Final_Algae[1:136], col="green", lwd=6)
lines(Hysteresis_output$Fishing[1:103], Hysteresis_output$Final_Algae[1:103], col="green", lwd=6)
lines(Hysteresis_output_2$Fishing[1:135], Hysteresis_output_2$Final_Algae[1:135], col="green", lwd=6)
lines(coral_connect$Fishing,coral_connect$Final_Algae, lty = 2, col="green", lwd=6)

# lines(Hysteresis_output$Fishing[1:104], Hysteresis_output$Final_Herbivores[1:104], col="blue", lwd=6)
# lines(Hysteresis_output_2$Fishing[1:136], Hysteresis_output_2$Final_Herbivores[1:136], col="blue", lwd=6)
lines(Hysteresis_output$Fishing[1:103], Hysteresis_output$Final_Herbivores[1:103], col="blue", lwd=6)
lines(Hysteresis_output_2$Fishing[1:135], Hysteresis_output_2$Final_Herbivores[1:135], col="blue", lwd=6)
lines(coral_connect$Fishing,coral_connect$Final_Herbivores, lty = 2, col="blue", lwd=6)


dev.off()

```





## Basic Model: Bistability Plot - Figure S2
# Under what conditions of fishing pressure and initial coral cover does the system exhibit bistability?
## Updated March 15, 2022 to have S0 = 0.15

```{r Bistability Analysis Heatmaps similar to Ranjans, cache=TRUE}

# Under what conditions of fishing pressure and initial coral cover does the system exhibit bistability?

tseq<-seq(0,1000,by=0.1)

# Start with different initial amounts of coral cover
# coral_initials<-seq(0,1,0.01)
coral_initials<-seq(0,0.85,0.01)

## Change the levels of fishing pressure
f_values<-seq(0,1,0.01)

basic_1<-expand.grid(coral_initials,f_values)
colnames(basic_1)<-c("Initial_Coral","Fishing_Pressure")


for(i in 1:length(basic_1$Initial_Coral)){
    C0<-basic_1$Initial_Coral[i]
    H0<-0.9
    S0<-0.15
    A0<-1-C0-S0
    pars[11]<-basic_1$Fishing_Pressure[i] # set the fishing pressure
    dd_output<-lsoda(c(Herbivores=H0,Coral=C0,Algae=A0), tseq, Basic_Model, pars)
    dd_output_new<-as.data.frame(dd_output)
    basic_1$Final_Coral[i]<-tail(dd_output_new$Coral,1)
}



# Set up a data frame to hold the desired output
dd_values<-data.frame(Initial_Coral_Cover = coral_initials, 
                               matrix(NA,
                                      nrow = length(coral_initials),
                                      ncol = length(f_values)))
names(dd_values)[2:(length(f_values)+1)] <- f_values



# Set up for loop to run lsoda with different initial coral cover conditions
# Nest a loop to fun lsoda for different fishing pressures for each coral cover
for(i in 1:length(coral_initials)){
  for(j in 1:length(f_values)){
    H0<-0.9
    C0<-coral_initials[i]
    S0<-0.05
    A0<-1-C0-S0
    pars[11]<-f_values[j] # loop through different fishing pressures
    dd_output<-lsoda(c(Herbivores=H0,Coral=C0,Algae=A0), tseq, Basic_Model, pars)
    dd_output_new<-as.data.frame(dd_output)
    dd_values[i,j+1]<-tail(dd_output_new$Coral,1)
  }
}

## Trying to figure out precisely which fishing pressure values the coral reef system exhibits bistability depending upon the initial coral cover conditions.
C0_0<-subset(basic_1,subset = basic_1$Initial_Coral == 0)
C0_0.85<-subset(basic_1,subset = basic_1$Initial_Coral == 0.85)

for(i in 1:nrow(C0_0)){
  C0_0$bistability[i]<-format(round(C0_0[i,3], 7), nsmall = 7) != 
                     format(round(C0_0.85[i,3], 7), nsmall = 7)
}


## Find the fishing pressure values where the system can exhibit bistability
min(C0_0$Fishing_Pressure[which(C0_0$bistability==TRUE)])
max(C0_0$Fishing_Pressure[which(C0_0$bistability==TRUE)])
C0_0$Fishing_Pressure[which(C0_0$bistability==TRUE)]
## bistability between 0.33 - 0.51






## Making Figure S2 - Basic Bistability Plot
# pdf("Basic_Bistability_FigS2.pdf",height=6, width=7)
# pdf("Basic_Bistability_FigS2.pdf",height=3, width=4.3)
pdf("Basic_Bistability_FigS2_v2.pdf",height=3, width=4.3)

ggplot(basic_1, aes(Fishing_Pressure, Initial_Coral)) +
  geom_tile(aes(fill = Final_Coral)) +
  theme_classic(base_size=12, base_family="Times") + 
  theme(axis.title=element_text(size=14,face="bold")) + 
  xlim(0,1) + 
  # ylim(0,1) + 
  ylim(0,0.85) + 
  ylab("Initial Coral Cover") +
  xlab("Fishing Pressure") +
  scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
  scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
  labs(fill = "Final\nCoral\nCover")
  # scale_x_discrete(expand = c(0, 0), name="Fishing Pressure",breaks=c(0.00,0.25,0.50,0.75,1.00)) +
  # scale_y_continuous(expand = c(0, 0))
#  scale_x_continuous(expand = c(0, 0)) + 
#  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.01)))

dev.off()


```










### Figures S3, S4, and S5 - Need to used the Expanded Model

# Expanded Model

```{r Expanded Model Set up}
#These were the initial conditions for the basic model when I first ran that...
# H0<-0.9
# C0<-0.75
# M0<-0.1


G0<-0.3
R0<-0.3
B0<-0.3
C0<-0.75
T0<-0.05
M0<-0.05
S0 <- 1 - T0 - C0 - M0

P2_state_vars<-c(GG=G0, RR=R0, BB=B0, CC=C0, TT=T0, MM=M0, SS=S0)

#generate a series of times at which you want the ODE solver to output population sizes
P2_tseq<-seq(0,1000,by=0.1)

#Generate a vector of parameter values
P2_pars<-c(bc<-0.3,
           bt<-0.8,      #use the same value as bm from basic model
           bm<-0.8,      #use the same value as bm from basic model
           ic<-0.05,
           it<-0.025,    #need two of these, one for turf and one for macroalgae
           im<-0.025,    #need two of these, one for turf and one for macroalgae
           dc<-0.1,
           r<-1,
           # gt<-1,       #need two of these, one for turf and one for macroalgae
           # gm<-1,       #need two of these, one for turf and one for macroalgae
           gt<-2,       #need two of these, one for turf and one for macroalgae
           gm<-2,       #need two of these, one for turf and one for macroalgae
           etaT<-1,     #need two of these, one for turf and one for macroalgae
           etaM<-1,     #need two of these, one for turf and one for macroalgae
           alphaT<-0.5,
           alphaM<-0.5,
           sigma<-0.6,
           f<-0.1,
           gamma<-0)

P2_Model<-function(P2_tseq,P2_state_vars,P2_pars){
  GG <- P2_state_vars[1]
  RR <- P2_state_vars[2]
  BB <- P2_state_vars[3]
  CC <- P2_state_vars[4]
  TT <- P2_state_vars[5]
  MM <- P2_state_vars[6]
  SS <- 1 - CC - TT - MM
  
  bc <- P2_pars[1]
  bt <- P2_pars[2]
  bm <- P2_pars[3]
  ic <- P2_pars[4]
  it <- P2_pars[5]
  im <- P2_pars[6]
  dc <- P2_pars[7]
  r <- P2_pars[8]
  gt <- P2_pars[9]
  gm <- P2_pars[10]
  etaT <- P2_pars[11]
  etaM <- P2_pars[12]
  alphaT <- P2_pars[13]
  alphaM <- P2_pars[14]
  sigma <- P2_pars[15]
  f <- P2_pars[16]
  gamma <- P2_pars[17]
  
  dG_dt <-r*GG*(1 - ((GG+RR+BB) / ((1-sigma) + sigma*CC))) - f*GG
  dR_dt <-r*RR*(1 - ((GG+RR+BB) / ((1-sigma) + sigma*CC))) - f*RR
  dB_dt <-r*BB*(1 - ((GG+RR+BB) / ((1-sigma) + sigma*CC))) - f*BB
  dC_dt <- (ic + bc*CC)*SS*(1-(alphaT*TT+alphaM*MM)) - dc*CC
  dT_dt <- (it + bt*TT)*(SS) - (gamma*TT) - (((gt*GG*TT) / (gt*etaT*TT+1)) + ((gt*RR*TT)/(gt*etaT*TT+gm*etaM*MM+1)))
  dM_dt <- (im + bm*MM)*(SS) + (gamma*TT) - (((gm*BB*MM) / (gm*etaM*MM+1)) + ((gm*RR*MM)/(gt*etaT*TT+gm*etaM*MM+1)))


  return(list(c(dG <- dG_dt,
                dR <- dR_dt,
                dB <- dB_dt,
                dC <- dC_dt,
                dT <- dT_dt,
                dM <- dM_dt)))
}

P2_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, P2_pars)
P2_output=as.data.frame(P2_output)

#head(P2_output)
#tail(P2_output)

P2_output$Space= 1 - P2_output$Coral - P2_output$Turf - P2_output$Macroalgae
P2_output$Herbivores = P2_output$Grazers+P2_output$Generalists+P2_output$Browsers
P2_output$Algae = P2_output$Turf+P2_output$Macroalgae


```



## Expanded Model Initial Conditions & Parameters

```{r}
#Generate a vector of parameter values
hh_pars<-c(bc<-0.3, bt<-0.8,bm<-0.5,      #expansion of current benthic cover
           ic<-0.05, it<-0.05, im<-0,     #import of propagules
           dc<-0.1,                       #coral mortality
           r<-1,                          #herbivore growth rate
#           gt<-1, gm<-0.5,                #algae mortality - used previously before changing our model equations
           gt<-2, gm<-1,                #algae mortality
           etaT<-0, etaM<-1,              #algae handling time
           alphaT<-0.25, alphaM<-0.5,     #competitive effect on coral
           sigma<-0.6,                    #relationship between coral & herbivores
           f<-0.5,                        #fishing pressure
           gamma<-0.1)                    #transition from turf to macroalgae

```


# Figure S3 RECOVERY for manuscript - panel figure of how different initial conditions of herbivorous fish affect final coral cover under different levels of fishing pressure - STARTING WITH LOW INITIAL CORAL COVER TO TALK ABOUT RECOVERY!!!

### Generalists set to 0
### Only keeping those combinations where total H is equal to or less than 0.9
```{r Figure S2 Recovery}

GG_values<-seq(0,0.9,by=0.025)
BB_values<-seq(0,0.9,by=0.025)

f_values<-seq(0,0.7,by=0.1)    ## this is what is different from the main text figure - showing additional fishing pressure levels

qq_initials_0<-expand.grid(GG_values,BB_values,f_values)
qq_initials_0$RR_values<-rep(0, length(qq_initials_0[,1]))
final_qq_0<-subset(qq_initials_0,rowSums(qq_initials_0[,c(1,2,4)])<=0.9)
colnames(final_qq_0)<-c("Grazers","Browsers","Fishing_Pressure","Generalists")


## Currently using hh_pars in lsoda below!!!!


for(i in 1:length(final_qq_0$Grazers)){
  G0<-final_qq_0$Grazers[i]
  B0<-final_qq_0$Browsers[i]
  R0<-final_qq_0$Generalists[i]
#  C0<-0.35
  C0<-0.15
  M0<-0.0
  T0<-0.1
  S0<-1-C0-M0-T0
  hh_pars[16]<-final_qq_0$Fishing_Pressure[i]   #set the fishing pressure
  zz_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, hh_pars)
  zz_output_new<-as.data.frame(zz_output)
  final_qq_0$Final_Coral[i]<-tail(zz_output_new$Coral,1)
  final_qq_0$Final_Turf[i]<-tail(zz_output_new$Turf,1)
  final_qq_0$Final_Macroalgae[i]<-tail(zz_output_new$Macroalgae,1)
  final_qq_0$Final_Grazers[i]<-tail(zz_output_new$Grazers,1)
  final_qq_0$Final_Browsers[i]<-tail(zz_output_new$Browsers,1)
  final_qq_0$Final_Generalists[i]<-tail(zz_output_new$Generalists,1)
}

```

## Figure S3 RECOVERY continuted

### Generalists set to 0.2
```{r}
GG_values<-seq(0,0.9,by=0.025)
BB_values<-seq(0,0.9,by=0.025)

f_values<-seq(0,0.7,by=0.1)  ## this is what is different from the main text figure - showing additional fishing pressure levels

qq_initials_2<-expand.grid(GG_values,BB_values,f_values)
qq_initials_2$RR_values<-rep(0.2, length(qq_initials_2[,1]))
final_qq_2<-subset(qq_initials_2,rowSums(qq_initials_2[,c(1,2,4)])<=0.9)
colnames(final_qq_2)<-c("Grazers","Browsers","Fishing_Pressure","Generalists")


## Currently using hh_pars in lsoda below!!!!

for(i in 1:length(final_qq_2$Grazers)){
  G0<-final_qq_2$Grazers[i]
  B0<-final_qq_2$Browsers[i]
  R0<-final_qq_2$Generalists[i]
  # C0<-0.35
  C0<-0.15
  M0<-0.0
  T0<-0.1
  S0<-1-C0-M0-T0
  hh_pars[16]<-final_qq_2$Fishing_Pressure[i]   #set the fishing pressure
  zz_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, hh_pars)
  zz_output_new<-as.data.frame(zz_output)
  final_qq_2$Final_Coral[i]<-tail(zz_output_new$Coral,1)
  final_qq_2$Final_Turf[i]<-tail(zz_output_new$Turf,1)
  final_qq_2$Final_Macroalgae[i]<-tail(zz_output_new$Macroalgae,1)
  final_qq_2$Final_Grazers[i]<-tail(zz_output_new$Grazers,1)
  final_qq_2$Final_Browsers[i]<-tail(zz_output_new$Browsers,1)
  final_qq_2$Final_Generalists[i]<-tail(zz_output_new$Generalists,1)
}
```

## Figure S3 RECOVERY continuted

### Generalists set to 0.4
```{r}
GG_values<-seq(0,0.9,by=0.025)
BB_values<-seq(0,0.9,by=0.025)

f_values<-seq(0,0.7,by=0.1)  ## this is what is different from the main text figure - showing addition fishing pressure levels

qq_initials_4<-expand.grid(GG_values,BB_values,f_values)
qq_initials_4$RR_values<-rep(0.4, length(qq_initials_4[,1]))
final_qq_4<-subset(qq_initials_4,rowSums(qq_initials_4[,c(1,2,4)])<=0.9)
colnames(final_qq_4)<-c("Grazers","Browsers","Fishing_Pressure","Generalists")


## Currently using hh_pars in lsoda below!!!!

for(i in 1:length(final_qq_4$Grazers)){
  G0<-final_qq_4$Grazers[i]
  B0<-final_qq_4$Browsers[i]
  R0<-final_qq_4$Generalists[i]
  # C0<-0.35
  C0<-0.15
  M0<-0.0
  T0<-0.1
  S0<-1-C0-M0-T0
  hh_pars[16]<-final_qq_4$Fishing_Pressure[i]   #set the fishing pressure
  zz_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, hh_pars)
  zz_output_new<-as.data.frame(zz_output)
  final_qq_4$Final_Coral[i]<-tail(zz_output_new$Coral,1)
  final_qq_4$Final_Turf[i]<-tail(zz_output_new$Turf,1)
  final_qq_4$Final_Macroalgae[i]<-tail(zz_output_new$Macroalgae,1)
  final_qq_4$Final_Grazers[i]<-tail(zz_output_new$Grazers,1)
  final_qq_4$Final_Browsers[i]<-tail(zz_output_new$Browsers,1)
  final_qq_4$Final_Generalists[i]<-tail(zz_output_new$Generalists,1)
}
```

## Figure S3 RECOVERY continuted - actually making the figure here!

### Plotting output
```{r}

# Row bind the various data frames in order to plot by them
final_qq_0$Id="Generalists = 0"
final_qq_2$Id="Generalists = 0.2"
final_qq_4$Id="Generalists = 0.4"
qqall=rbind(final_qq_0, final_qq_2, final_qq_4)

#Getting names for Fishing Pressure so can plot them....
qqall$Fishing_ID = qqall$Fishing_Pressure
qqall$Fishing_ID <- as.factor(qqall$Fishing_ID)
levels(qqall$Fishing_ID)
levels(qqall$Fishing_ID)[levels(qqall$Fishing_ID)=="0"]<-"Fishing\nPressure\n= 0"
levels(qqall$Fishing_ID)[levels(qqall$Fishing_ID)=="0.1"]<-"Fishing\nPressure\n= 0.1"
levels(qqall$Fishing_ID)[levels(qqall$Fishing_ID)=="0.2"]<-"Fishing\nPressure\n= 0.2"
levels(qqall$Fishing_ID)[levels(qqall$Fishing_ID)=="0.3"]<-"Fishing\nPressure\n= 0.3"
levels(qqall$Fishing_ID)[levels(qqall$Fishing_ID)=="0.4"]<-"Fishing\nPressure\n= 0.4"
levels(qqall$Fishing_ID)[levels(qqall$Fishing_ID)=="0.5"]<-"Fishing\nPressure\n= 0.5"
levels(qqall$Fishing_ID)[levels(qqall$Fishing_ID)=="0.6"]<-"Fishing\nPressure\n= 0.6"
levels(qqall$Fishing_ID)[levels(qqall$Fishing_ID)=="0.7"]<-"Fishing\nPressure\n= 0.7"
levels(qqall$Fishing_ID)


## library(lemon)


# pdf("Paper_Fig_S3_v2_abundance.pdf",width=6, height=12)
pdf("Paper_Fig_S3_v3_C0.15.pdf",width=6, height=12)

#quartz()
## Making this plot with facet_rep_grid instead of facet_wrap so can better label the rows and columns
ggplot(data=qqall, aes(Grazers, Browsers)) +
      geom_tile(aes(fill = Final_Coral)) +
      theme_classic(base_size=10,base_family="Times") +
      theme(axis.title=element_text(size=11,face="bold")) + 
      scale_x_continuous("Grazer Abundance",breaks = c(0,0.3,0.6,0.9),
                         labels = c(0,0.3,0.6,0.9),limits = c(0,0.9)) +
      scale_y_continuous("Browser Abundance",breaks = c(0,0.3,0.6,0.9),
                         labels = c(0,0.3,0.6,0.9),limits = c(0,0.9)) +
      labs(fill = "Final\nCoral\nCover") +
#      ggtitle(paste("Fishing Pressure = ",f_values[i])) + 
      scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
      scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
  facet_rep_grid(Fishing_ID~Id) +
  coord_capped_cart(bottom='both', left='both') +
  theme(strip.text.x = element_text(size = 11)) + 
  theme(strip.text.y = element_text(size = 11,angle = 0))

dev.off()


```



### Plotting a subset of the above scenarios for the MAIN TEXT FIGURE - Figure 2, which is showing the recovery following a disturbance
## Figure 2 for main text

```{r}

## Need to subset the qqall data frame for just fishing pressures of 0, 0.3, and 0.6

qqall_0f<-subset(qqall,Fishing_Pressure == 0)
qqall_0.3f<-subset(qqall,Fishing_Pressure == "0.3")
qqall_0.5f<-subset(qqall,Fishing_Pressure == "0.5")
# qqall_0.6f<-subset(qqall,Fishing_Pressure == "0.6")
# 
# qqall_small=rbind(qqall_0f, qqall_0.3f, qqall_0.6f)
qqall_small=rbind(qqall_0f, qqall_0.3f, qqall_0.5f)

#Getting names for Fishing Pressure so can plot them....
qqall_small$Fishing_ID <- as.factor(qqall_small$Fishing_ID)
qqall_small$Id <- as.factor(qqall_small$Id)


# levels(qqall_small$Fishing_ID)
# levels(qqall_small$Fishing_ID)[levels(qqall_small$Fishing_ID)=="0"]<-"Fishing\nPressure\n= 0"
# levels(qqall_small$Fishing_ID)[levels(qqall_small$Fishing_ID)=="0.3"]<-"Fishing\nPressure\n= 0.3"
# levels(qqall_small$Fishing_ID)[levels(qqall_small$Fishing_ID)=="0.6"]<-"Fishing\nPressure\n= 0.6"
# levels(qqall_small$Fishing_ID)


# pdf("Fig_2_NEW_abundance.pdf",width=7, height=5.7)
pdf("Fig_2_NEW_abundance_v2.pdf",width=7, height=5.7)

#quartz()
## Making this plot with facet_rep_grid instead of facet_wrap so can better label the rows and columns
ggplot(data=qqall_small, aes(Grazers, Browsers)) +
      geom_tile(aes(fill = Final_Coral)) +
      theme_classic(base_size=10,base_family="Times") +
      theme(axis.title=element_text(size=11,face="bold")) + 
      scale_x_continuous("Grazer Abundance",breaks = c(0,0.3,0.6,0.9),
                         labels = c(0,0.3,0.6,0.9),limits = c(0,0.9)) +
      scale_y_continuous("Browser Abundance",breaks = c(0,0.3,0.6,0.9),
                         labels = c(0,0.3,0.6,0.9),limits = c(0,0.9)) +
      labs(fill = "Final\nCoral\nCover") +
#      ggtitle(paste("Fishing Pressure = ",f_values[i])) + 
      scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
      scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
  facet_rep_grid(Fishing_ID~Id) +
  coord_capped_cart(bottom='both', left='both') +
  theme(strip.text.x = element_text(size = 11)) + 
  theme(strip.text.y = element_text(size = 11,angle = 0))

dev.off()


```

## Plotting a subset of Main Text Figure 2 to use in ICRS 2021 Presentation

```{r}

##subset the data
qqall_0f_0R<-subset(qqall_0f,Generalists == 0)

## Plot for just one output for ICRS 2021 presentation
pdf("ESA_Figure_1.pdf",width=4,height=3)


#quartz()
ggplot(data=qqall_0f_0R, aes(Grazers, Browsers)) +
      geom_tile(aes(fill = Final_Coral)) +
      theme_classic(base_size=10,base_family="Times") +
      theme(axis.title=element_text(size=11,face="bold")) + 
      labs(fill = "Final\nCoral\nCover") +
      scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
      scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
      scale_x_continuous("Grazer Abundance",expand = c(0, 0), breaks = c(0,0.3,0.6,0.9),
                         labels = c(0,0.3,0.6,0.9),limits = c(0,0.9)) +
    # scale_x_discrete(expand = c(0, 0), name="Grazer Abundance",breaks=c(0,0.3,0.6,0.9), limits = factor(0,0.9)) +
    scale_y_continuous("Browser Abundance", expand = c(0, 0), breaks = c(0,0.3,0.6,0.9),
                         labels = c(0,0.3,0.6,0.9), limits = c(0,0.9))

dev.off()

```









# Figure S4 for manuscript - panel figure showing how varying initial macroalgal and turf covers affect final coral cover under different fishing and initial coral cover scenarios

```{r}

turf_values<-seq(0,0.7,by=0.01)
macro_values<-seq(0,0.7,by=0.01)

f_values<-seq(0,0.7,by=0.1)     ## this is what is different from the main text figure - showing additional fishing pressure levels

algae_initials<-expand.grid(turf_values,macro_values,f_values)

#Only those conditions where total initial algae is less than or equal to 0.1
final_algae_1<-subset(algae_initials,rowSums(algae_initials[,c(1,2)])<=0.1)
colnames(final_algae_1)<-c("Turf","Macroalgae","Fishing_Pressure")

#Only those conditions where total initial algae is less than or equal to 0.3
final_algae_2<-subset(algae_initials,rowSums(algae_initials[,c(1,2)])<=0.3)
colnames(final_algae_2)<-c("Turf","Macroalgae","Fishing_Pressure")

#Only those conditions where total initial algae is less than or equal to 0.5
final_algae_3<-subset(algae_initials,rowSums(algae_initials[,c(1,2)])<=0.5)
colnames(final_algae_3)<-c("Turf","Macroalgae","Fishing_Pressure")

#Only those conditions where total initial algae is less than or equal to 0.7
final_algae_4<-subset(algae_initials,rowSums(algae_initials[,c(1,2)])<=0.7)
colnames(final_algae_4)<-c("Turf","Macroalgae","Fishing_Pressure")


# Run simulations for algae <= 0.1
for(i in 1:length(final_algae_1$Turf)){
  G0<-0.3
  B0<-0.3
  R0<-0.3
  C0<-0.75
  M0<-final_algae_1$Macroalgae[i]
  T0<-final_algae_1$Turf[i]
  S0<-1-C0-M0-T0
  hh_pars[16]<-final_algae_1$Fishing_Pressure[i]   #set the fishing pressure
  zz_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, hh_pars)
  zz_output_new<-as.data.frame(zz_output)
  final_algae_1$Final_Coral[i]<-tail(zz_output_new$Coral,1)
  final_algae_1$Final_Turf[i]<-tail(zz_output_new$Turf,1)
  final_algae_1$Final_Macroalgae[i]<-tail(zz_output_new$Macroalgae,1)
  final_algae_1$Coral_switch[i]<-zz_output_new[which.max(zz_output_new$Coral<0.5),1]
  final_algae_1$Macro_switch[i]<-zz_output_new[which.max(zz_output_new$Macroalgae>0.5),1]
  final_algae_1$Algal_switch[i]<-zz_output_new[which.max((zz_output_new$Turf + zz_output_new$Macroalgae)>0.5),1]
  final_algae_1$Final_Grazers[i]<-tail(zz_output_new$Grazers,1)
  final_algae_1$Final_Generalists[i]<-tail(zz_output_new$Generalists,1)
  final_algae_1$Final_Browsers[i]<-tail(zz_output_new$Browsers,1)
}


# Run simulations for algae <=0.3
for(i in 1:length(final_algae_2$Turf)){
  G0<-0.3
  B0<-0.3
  R0<-0.3
  C0<-0.55
  M0<-final_algae_2$Macroalgae[i]
  T0<-final_algae_2$Turf[i]
  S0<-1-C0-M0-T0
  hh_pars[16]<-final_algae_2$Fishing_Pressure[i]   #set the fishing pressure
  zz_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, hh_pars)
  zz_output_new<-as.data.frame(zz_output)
  final_algae_2$Final_Coral[i]<-tail(zz_output_new$Coral,1)
  final_algae_2$Final_Turf[i]<-tail(zz_output_new$Turf,1)
  final_algae_2$Final_Macroalgae[i]<-tail(zz_output_new$Macroalgae,1)
  final_algae_2$Coral_switch[i]<-zz_output_new[which.max(zz_output_new$Coral<0.5),1]
  final_algae_2$Macro_switch[i]<-zz_output_new[which.max(zz_output_new$Macroalgae>0.5),1]
  final_algae_2$Algal_switch[i]<-zz_output_new[which.max((zz_output_new$Turf + zz_output_new$Macroalgae)>0.5),1]
  final_algae_2$Final_Grazers[i]<-tail(zz_output_new$Grazers,1)
  final_algae_2$Final_Generalists[i]<-tail(zz_output_new$Generalists,1)
  final_algae_2$Final_Browsers[i]<-tail(zz_output_new$Browsers,1)
}


# Run simulations for algae <= 0.5
for(i in 1:length(final_algae_3$Turf)){
  G0<-0.3
  B0<-0.3
  R0<-0.3
  C0<-0.35
  M0<-final_algae_3$Macroalgae[i]
  T0<-final_algae_3$Turf[i]
  S0<-1-C0-M0-T0
  hh_pars[16]<-final_algae_3$Fishing_Pressure[i]   #set the fishing pressure
  zz_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, hh_pars)
  zz_output_new<-as.data.frame(zz_output)
  final_algae_3$Final_Coral[i]<-tail(zz_output_new$Coral,1)
  final_algae_3$Final_Turf[i]<-tail(zz_output_new$Turf,1)
  final_algae_3$Final_Macroalgae[i]<-tail(zz_output_new$Macroalgae,1)
  final_algae_3$Coral_switch[i]<-zz_output_new[which.max(zz_output_new$Coral<0.5),1]
  final_algae_3$Macro_switch[i]<-zz_output_new[which.max(zz_output_new$Macroalgae>0.5),1]
  final_algae_3$Algal_switch[i]<-zz_output_new[which.max((zz_output_new$Turf + zz_output_new$Macroalgae)>0.5),1]
  final_algae_3$Final_Grazers[i]<-tail(zz_output_new$Grazers,1)
  final_algae_3$Final_Generalists[i]<-tail(zz_output_new$Generalists,1)
  final_algae_3$Final_Browsers[i]<-tail(zz_output_new$Browsers,1)
}



# Run simulations for algae <= 0.7
for(i in 1:length(final_algae_4$Turf)){
  G0<-0.3
  B0<-0.3
  R0<-0.3
  C0<-0.15
  M0<-final_algae_4$Macroalgae[i]
  T0<-final_algae_4$Turf[i]
  S0<-1-C0-M0-T0
  hh_pars[16]<-final_algae_4$Fishing_Pressure[i]   #set the fishing pressure
  zz_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, hh_pars)
  zz_output_new<-as.data.frame(zz_output)
  final_algae_4$Final_Coral[i]<-tail(zz_output_new$Coral,1)
  final_algae_4$Final_Turf[i]<-tail(zz_output_new$Turf,1)
  final_algae_4$Final_Macroalgae[i]<-tail(zz_output_new$Macroalgae,1)
  final_algae_4$Coral_switch[i]<-zz_output_new[which.max(zz_output_new$Coral<0.5),1]
  final_algae_4$Macro_switch[i]<-zz_output_new[which.max(zz_output_new$Macroalgae>0.5),1]
  final_algae_4$Algal_switch[i]<-zz_output_new[which.max((zz_output_new$Turf + zz_output_new$Macroalgae)>0.5),1]
  final_algae_4$Final_Grazers[i]<-tail(zz_output_new$Grazers,1)
  final_algae_4$Final_Generalists[i]<-tail(zz_output_new$Generalists,1)
  final_algae_4$Final_Browsers[i]<-tail(zz_output_new$Browsers,1)
}


```

## Figure S4 continued
### Actually making the figure

```{r}

# Row bind the various data frames in order to plot by them
final_algae_1$Id="Initial\nCoral = 0.75"
final_algae_2$Id="Initial\nCoral = 0.55"
final_algae_3$Id="Initial\nCoral = 0.35"
final_algae_4$Id="Initial\nCoral = 0.15"
algae_all=rbind(final_algae_1, final_algae_2, final_algae_3, final_algae_4)

#Getting names for Fishing Pressure so can plot them....
algae_all$Fishing_ID = algae_all$Fishing_Pressure
algae_all$Fishing_ID <- as.factor(algae_all$Fishing_ID)
levels(algae_all$Fishing_ID)
levels(algae_all$Fishing_ID)[levels(algae_all$Fishing_ID)=="0"]<-"Fishing\nPressure\n= 0"
levels(algae_all$Fishing_ID)[levels(algae_all$Fishing_ID)=="0.1"]<-"Fishing\nPressure\n= 0.1"
levels(algae_all$Fishing_ID)[levels(algae_all$Fishing_ID)=="0.2"]<-"Fishing\nPressure\n= 0.2"
levels(algae_all$Fishing_ID)[levels(algae_all$Fishing_ID)=="0.3"]<-"Fishing\nPressure\n= 0.3"
levels(algae_all$Fishing_ID)[levels(algae_all$Fishing_ID)=="0.4"]<-"Fishing\nPressure\n= 0.4"
levels(algae_all$Fishing_ID)[levels(algae_all$Fishing_ID)=="0.5"]<-"Fishing\nPressure\n= 0.5"
levels(algae_all$Fishing_ID)[levels(algae_all$Fishing_ID)=="0.6"]<-"Fishing\nPressure\n= 0.6"
levels(algae_all$Fishing_ID)[levels(algae_all$Fishing_ID)=="0.7"]<-"Fishing\nPressure\n= 0.7"
levels(algae_all$Fishing_ID)


pdf("Paper_Fig_S4_v2_abundance.pdf",width=6, height=9)

#quartz()
ggplot(algae_all, aes(Turf, Macroalgae)) +
      geom_tile(aes(fill = Final_Coral)) +
      theme_classic(base_size=10,base_family="Times") + 
      theme(axis.title=element_text(size=11,face="bold")) + 
      # xlim(0,0.7) + 
      # ylim(0,0.7) + 
      scale_x_continuous("Initial Turf Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      scale_y_continuous("Initial Macroalgal Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      # ylab("Initial Macroalgal Proportion") +
      # xlab("Initial Turf Proportion") +
      labs(fill = "Final\nCoral\nCover") +
      scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
      scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
    facet_rep_grid(Fishing_ID~Id) +
    coord_capped_cart(bottom='both', left='both') +
    theme(strip.text.x = element_text(size = 11)) + 
    theme(strip.text.y = element_text(size = 11,angle = 0))

dev.off()


```


### Plotting a subset of the above scenarios for the MAIN TEXT FIGURE - Figure 3, which is showing how initial covers of turf, macroalgae, and coral interact
## Figure 3 for main text

```{r}

## Need to subset the algae_all data frame for just fishing pressures of 0.4, 0.5, and 0.6
## Need to subset the algae_all data frame for just initial coral covers of 0.15, 0.35, and 0.55

algae_all_0.4f<-subset(algae_all,Fishing_Pressure == "0.4")
algae_all_0.5f<-subset(algae_all,Fishing_Pressure == "0.5")
algae_all_0.6f<-subset(algae_all,Fishing_Pressure == "0.6")

algae_all_small=rbind(algae_all_0.4f, algae_all_0.5f, algae_all_0.6f)
algae_all_small_C<-subset(algae_all_small, Id != "Initial\nCoral = 0.75")

#Getting names for Fishing Pressure so can plot them....
algae_all_small_C$Fishing_ID <- as.factor(algae_all_small_C$Fishing_ID)
algae_all_small_C$Id <- as.factor(algae_all_small_C$Id)


levels(algae_all_small_C$Id)
levels(algae_all_small_C$Id)[levels(algae_all_small_C$Id)=="Initial\nCoral = 0.55"]<-"Initial Coral = 0.55"
levels(algae_all_small_C$Id)[levels(algae_all_small_C$Id)=="Initial\nCoral = 0.35"]<-"Initial Coral = 0.35"
levels(algae_all_small_C$Id)[levels(algae_all_small_C$Id)=="Initial\nCoral = 0.15"]<-"Initial Coral = 0.15"
levels(algae_all_small_C$Id)



pdf("Fig_3_NEW.pdf",width=7, height=5.7)

#quartz()
## Making this plot with facet_rep_grid instead of facet_wrap so can better label the rows and columns
ggplot(algae_all_small_C, aes(Turf, Macroalgae)) +
      geom_tile(aes(fill = Final_Coral)) +
      theme_classic(base_size=10,base_family="Times") + 
      theme(axis.title=element_text(size=11,face="bold")) + 
      # xlim(0,0.7) + 
      # ylim(0,0.7) + 
      scale_x_continuous("Initial Turf Proportion",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      scale_y_continuous("Initial Macroalgal Proportion",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      # ylab("Initial Macroalgal Proportion") +
      # xlab("Initial Turf Proportion") +
      labs(fill = "Final\nCoral\nCover") +
      scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
      scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
    facet_rep_grid(Fishing_ID~Id) +
    coord_capped_cart(bottom='both', left='both') +
    theme(strip.text.x = element_text(size = 11)) + 
    theme(strip.text.y = element_text(size = 11,angle = 0))

dev.off()


```







# Figure S5 for manuscript - panel figure showing how varying initial macroalgal and turf covers affect final coral cover under different dominant herbivore scenarios (high generalists, high browsers, high grazers)

```{r}

turf_values<-seq(0,0.7,by=0.01)
macro_values<-seq(0,0.7,by=0.01)

f_values<-seq(0,0.7,by=0.1)   ## this is what is different from the main text figure - showing addition fishing pressure levels

algae_initials<-expand.grid(turf_values,macro_values,f_values)

#Only those conditions where total initial algae is less than or equal to 0.7
final_algae_10<-subset(algae_initials,rowSums(algae_initials[,c(1,2)])<=0.7)
colnames(final_algae_10)<-c("Turf","Macroalgae","Fishing_Pressure")

final_algae_11<-subset(algae_initials,rowSums(algae_initials[,c(1,2)])<=0.7)
colnames(final_algae_11)<-c("Turf","Macroalgae","Fishing_Pressure")

final_algae_12<-subset(algae_initials,rowSums(algae_initials[,c(1,2)])<=0.7)
colnames(final_algae_12)<-c("Turf","Macroalgae","Fishing_Pressure")


# Run simulations for algae <= 0.7
## High Grazers Simulations
# Initial Herbivores Abundances: Grazers = 0.6, Browsers = 0.15, Generalists = 0.15
for(i in 1:length(final_algae_10$Turf)){
  G0<-0.6
  B0<-0.15
  R0<-0.15
  C0<-0.15
  M0<-final_algae_10$Macroalgae[i]
  T0<-final_algae_10$Turf[i]
  S0<-1-C0-M0-T0
  hh_pars[16]<-final_algae_10$Fishing_Pressure[i]   #set the fishing pressure
  zz_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, hh_pars)
  zz_output_new<-as.data.frame(zz_output)
  final_algae_10$Final_Coral[i]<-tail(zz_output_new$Coral,1)
  final_algae_10$Final_Turf[i]<-tail(zz_output_new$Turf,1)
  final_algae_10$Final_Macroalgae[i]<-tail(zz_output_new$Macroalgae,1)
  final_algae_10$Coral_switch[i]<-zz_output_new[which.max(zz_output_new$Coral<0.5),1]
  final_algae_10$Macro_switch[i]<-zz_output_new[which.max(zz_output_new$Macroalgae>0.5),1]
  final_algae_10$Algal_switch[i]<-zz_output_new[which.max((zz_output_new$Turf + zz_output_new$Macroalgae)>0.5),1]
}


# Run simulations for algae <= 0.7
## High Browsers Simulations
# Initial Herbivores Abundances: Grazers = 0.15, Browsers = 0.6, Generalists = 0.15
for(i in 1:length(final_algae_11$Turf)){
  G0<-0.15
  B0<-0.6
  R0<-0.15
  C0<-0.15
  M0<-final_algae_11$Macroalgae[i]
  T0<-final_algae_11$Turf[i]
  S0<-1-C0-M0-T0
  hh_pars[16]<-final_algae_11$Fishing_Pressure[i]   #set the fishing pressure
  zz_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, hh_pars)
  zz_output_new<-as.data.frame(zz_output)
  final_algae_11$Final_Coral[i]<-tail(zz_output_new$Coral,1)
  final_algae_11$Final_Turf[i]<-tail(zz_output_new$Turf,1)
  final_algae_11$Final_Macroalgae[i]<-tail(zz_output_new$Macroalgae,1)
  final_algae_11$Coral_switch[i]<-zz_output_new[which.max(zz_output_new$Coral<0.5),1]
  final_algae_11$Macro_switch[i]<-zz_output_new[which.max(zz_output_new$Macroalgae>0.5),1]
  final_algae_11$Algal_switch[i]<-zz_output_new[which.max((zz_output_new$Turf + zz_output_new$Macroalgae)>0.5),1]
}


# Run simulations for algae <= 0.7
## High Generalists Simulations
# Initial Herbivores Abundances: Grazers = 0.15, Browsers = 0.15, Generalists = 0.6
for(i in 1:length(final_algae_12$Turf)){
  G0<-0.15
  B0<-0.15
  R0<-0.6
  C0<-0.15
  M0<-final_algae_12$Macroalgae[i]
  T0<-final_algae_12$Turf[i]
  S0<-1-C0-M0-T0
  hh_pars[16]<-final_algae_12$Fishing_Pressure[i]   #set the fishing pressure
  zz_output<-lsoda(c(Grazers =G0, Generalists =R0, Browsers =B0,
                   Coral = C0,Turf = T0,Macroalgae=M0),
                 P2_tseq, P2_Model, hh_pars)
  zz_output_new<-as.data.frame(zz_output)
  final_algae_12$Final_Coral[i]<-tail(zz_output_new$Coral,1)
  final_algae_12$Final_Turf[i]<-tail(zz_output_new$Turf,1)
  final_algae_12$Final_Macroalgae[i]<-tail(zz_output_new$Macroalgae,1)
  final_algae_12$Coral_switch[i]<-zz_output_new[which.max(zz_output_new$Coral<0.5),1]
  final_algae_12$Macro_switch[i]<-zz_output_new[which.max(zz_output_new$Macroalgae>0.5),1]
  final_algae_12$Algal_switch[i]<-zz_output_new[which.max((zz_output_new$Turf + zz_output_new$Macroalgae)>0.5),1]
}

```



## Figure S5 continued
### Actually making the figure

```{r}

# Row bind the various data frames in order to plot by them
final_algae_10$Id="Grazer\ndominated"
final_algae_11$Id="Browser\ndominated"
final_algae_12$Id="Generalist\ndominated"

#rbind them in order in which I want the different herbivore scenarios plotted
algae_all_2=rbind(final_algae_10, final_algae_11, final_algae_12)
#algae_all_2=rbind(final_algae_4, final_algae_5, final_algae_6)

#bistability_all$Id <- factor(bistability_all$Id, levels=c("Collapsed","Expanded","High Generalists","High Browsers","High Grazers"))

#Reorder levels of herbivores for plotting
algae_all_2$Id = factor(algae_all_2$Id,levels=c("Generalist\ndominated","Browser\ndominated","Grazer\ndominated"))


#Getting names for Fishing Pressure so can plot them....
algae_all_2$Fishing_ID = algae_all_2$Fishing_Pressure
algae_all_2$Fishing_ID <- as.factor(algae_all_2$Fishing_ID)
levels(algae_all_2$Fishing_ID)
levels(algae_all_2$Fishing_ID)[levels(algae_all_2$Fishing_ID)=="0"]<-"Fishing\nPressure\n= 0"
levels(algae_all_2$Fishing_ID)[levels(algae_all_2$Fishing_ID)=="0.1"]<-"Fishing\nPressure\n= 0.1"
levels(algae_all_2$Fishing_ID)[levels(algae_all_2$Fishing_ID)=="0.2"]<-"Fishing\nPressure\n= 0.2"
levels(algae_all_2$Fishing_ID)[levels(algae_all_2$Fishing_ID)=="0.3"]<-"Fishing\nPressure\n= 0.3"
levels(algae_all_2$Fishing_ID)[levels(algae_all_2$Fishing_ID)=="0.4"]<-"Fishing\nPressure\n= 0.4"
levels(algae_all_2$Fishing_ID)[levels(algae_all_2$Fishing_ID)=="0.5"]<-"Fishing\nPressure\n= 0.5"
levels(algae_all_2$Fishing_ID)[levels(algae_all_2$Fishing_ID)=="0.6"]<-"Fishing\nPressure\n= 0.6"
levels(algae_all_2$Fishing_ID)[levels(algae_all_2$Fishing_ID)=="0.7"]<-"Fishing\nPressure\n= 0.7"
levels(algae_all_2$Fishing_ID)


pdf("Paper_Fig_S5_v2_abundance.pdf",width=4.5, height=8)

#quartz()
ggplot(algae_all_2, aes(Turf, Macroalgae)) +
  geom_tile(aes(fill = Final_Coral)) +
  theme_classic(base_size=10,base_family="Times") + 
  theme(axis.title=element_text(size=11,face="bold")) +
  # xlim(0,0.7) + 
  # ylim(0,0.7) + 
  # ylab("Initial Macroalgal Proportion") +
  # xlab("Initial Turf Proportion") +
  scale_x_continuous("Initial Turf Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      scale_y_continuous("Initial Macroalgal Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
  labs(fill = "Final\nCoral\nCover") +
  scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
  scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
    facet_rep_grid(Fishing_ID~Id) + 
    coord_capped_cart(bottom='both', left='both') +
    theme(strip.text.x = element_text(size = 10)) + 
    theme(strip.text.y = element_text(size = 10,angle = 0))

dev.off()

```




### Plotting a subset of the above scenarios for the MAIN TEXT FIGURE - Figure 4, which is showing how initial covers of turf, macroalgae, and different herbivore communities interact
## Figure 4 for main text

```{r Fig. 4 main text}

## Need to subset the algae_all data frame for just fishing pressures of 0, 0.3, and 0.6
algae_all_2_0f<-subset(algae_all_2,Fishing_Pressure == "0")
algae_all_2_0.3f<-subset(algae_all_2,Fishing_Pressure == "0.3")
algae_all_2_0.6f<-subset(algae_all_2,Fishing_Pressure == "0.6")

## Row bind the different subsets into one
algae_all_2_small=rbind(algae_all_2_0f, algae_all_2_0.3f, algae_all_2_0.6f)

#Getting names for Fishing Pressure so can plot them....
algae_all_2_small$Fishing_ID <- as.factor(algae_all_2_small$Fishing_ID)
algae_all_2_small$Id <- as.factor(algae_all_2_small$Id)


levels(algae_all_2_small$Id)[levels(algae_all_2_small$Id)=="Grazer\ndominated"]<-"Grazer-dominated"
levels(algae_all_2_small$Id)[levels(algae_all_2_small$Id)=="Browser\ndominated"]<-"Browser-dominated"
levels(algae_all_2_small$Id)[levels(algae_all_2_small$Id)=="Generalist\ndominated"]<-"Generalist-dominated"
levels(algae_all_2_small$Id)




pdf("Fig_4_NEW.pdf",width=7, height=5.7)

#quartz()
## Making this plot with facet_rep_grid instead of facet_wrap so can better label the rows and columns
ggplot(algae_all_2_small, aes(Turf, Macroalgae)) +
      geom_tile(aes(fill = Final_Coral)) +
      theme_classic(base_size=10,base_family="Times") + 
      theme(axis.title=element_text(size=11,face="bold")) + 
      # xlim(0,0.7) + 
      # ylim(0,0.7) + 
      scale_x_continuous("Initial Turf Proportion",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      scale_y_continuous("Initial Macroalgal Proportion",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      # ylab("Initial Macroalgal Proportion") +
      # xlab("Initial Turf Proportion") +
      labs(fill = "Final\nCoral\nCover") +
      scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
      scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
    facet_rep_grid(Fishing_ID~Id) +
    coord_capped_cart(bottom='both', left='both') +
    theme(strip.text.x = element_text(size = 11)) + 
    theme(strip.text.y = element_text(size = 11,angle = 0))

dev.off()


```


## June 25, 2022 - Making a figure showing the final turf and macroalgal cover values for Q2


## Plotting the above output, but showing final TURF cover instead of final coral cover

```{r Examining final TURF cover}

pdf("Fig_4_Final_Turf.pdf",width=7, height=5.7)

#quartz()
## Making this plot with facet_rep_grid instead of facet_wrap so can better label the rows and columns
ggplot(algae_all_2_small, aes(Turf, Macroalgae)) +
      geom_tile(aes(fill = Final_Turf)) +
      theme_classic(base_size=10,base_family="Times") + 
      theme(axis.title=element_text(size=11,face="bold")) + 
      # xlim(0,0.7) + 
      # ylim(0,0.7) + 
      scale_x_continuous("Initial Turf Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      scale_y_continuous("Initial Macroalgal Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      # ylab("Initial Macroalgal Proportion") +
      # xlab("Initial Turf Proportion") +
      labs(fill = "Final\nCover of\nTurf") +
      scale_fill_continuous_divergingx(palette = "Fall", limits=c(-1,1)) +
      # scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
      # scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
    facet_rep_grid(Fishing_ID~Id) +
    coord_capped_cart(bottom='both', left='both') +
    theme(strip.text.x = element_text(size = 11)) + 
    theme(strip.text.y = element_text(size = 11,angle = 0))

dev.off()

```



## Plotting the above output, but showing final MACROALGAL cover instead of final coral cover

```{r Examining final MACROALGAL cover}

pdf("Fig_4_Final_Macro.pdf",width=7, height=5.7)

#quartz()
## Making this plot with facet_rep_grid instead of facet_wrap so can better label the rows and columns
ggplot(algae_all_2_small, aes(Turf, Macroalgae)) +
      geom_tile(aes(fill = Final_Macroalgae)) +
      theme_classic(base_size=10,base_family="Times") + 
      theme(axis.title=element_text(size=11,face="bold")) + 
      # xlim(0,0.7) + 
      # ylim(0,0.7) + 
      scale_x_continuous("Initial Turf Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      scale_y_continuous("Initial Macroalgal Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      # ylab("Initial Macroalgal Proportion") +
      # xlab("Initial Turf Proportion") +
      labs(fill = "Final\nCover of\nMacroalgae") +
      scale_fill_continuous_divergingx(palette = "Fall", limits=c(-1,1)) +
      # scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
      # scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
    facet_rep_grid(Fishing_ID~Id) +
    coord_capped_cart(bottom='both', left='both') +
    theme(strip.text.x = element_text(size = 11)) + 
    theme(strip.text.y = element_text(size = 11,angle = 0))

dev.off()

```




## Calculate one variable to show both turf and macroalgae...

```{r}

algae_all_2_small$TurfMacro<-(algae_all_2_small$Final_Turf) / (algae_all_2_small$Final_Macroalgae)

algae_all_2_small$Turf_or_Macro<-ifelse(
  algae_all_2_small$Final_Turf>algae_all_2_small$Final_Macroalgae,
                              algae_all_2_small$Final_Turf,
                              -algae_all_2_small$Final_Macroalgae)

```



## Plotting the above Turf / Macroalgae and Turf OR Macroalgae variables...

```{r}


pdf("Fig_4_Final_TurfMacro.pdf",width=7, height=5.7)
#quartz()
## Making this plot with facet_rep_grid instead of facet_wrap so can better label the rows and columns
ggplot(algae_all_2_small, aes(Turf, Macroalgae)) +
      geom_tile(aes(fill = TurfMacro)) +
      theme_classic(base_size=10,base_family="Times") + 
      theme(axis.title=element_text(size=11,face="bold")) + 
      # xlim(0,0.7) + 
      # ylim(0,0.7) + 
      scale_x_continuous("Initial Turf Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      scale_y_continuous("Initial Macroalgal Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      # ylab("Initial Macroalgal Proportion") +
      # xlab("Initial Turf Proportion") +
      labs(fill = "Final\nCover of\nTurf / \nMacroalgae") +
      scale_fill_continuous_divergingx(palette = "Fall", limits=c(-1,1)) +
      # scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
      # scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
    facet_rep_grid(Fishing_ID~Id) +
    coord_capped_cart(bottom='both', left='both') +
    theme(strip.text.x = element_text(size = 11)) + 
    theme(strip.text.y = element_text(size = 11,angle = 0))

dev.off()




pdf("Fig_4_Final_TurfORMacro.pdf",width=7, height=5.7)

#quartz()
## Making this plot with facet_rep_grid instead of facet_wrap so can better label the rows and columns
ggplot(algae_all_2_small, aes(Turf, Macroalgae)) +
      geom_tile(aes(fill = Turf_or_Macro)) +
      theme_classic(base_size=10,base_family="Times") + 
      theme(axis.title=element_text(size=11,face="bold")) + 
      # xlim(0,0.7) + 
      # ylim(0,0.7) + 
      scale_x_continuous("Initial Turf Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      scale_y_continuous("Initial Macroalgal Abundance",breaks = c(0,0.2,0.4,0.6,0.8),
                         labels = c(0,0.2,0.4,0.6,0.8),limits = c(0,0.8)) +
      # ylab("Initial Macroalgal Proportion") +
      # xlab("Initial Turf Proportion") +
      labs(fill = "Final\nCover of\nTurf or\nMacroalgae") +
      scale_fill_continuous_divergingx(palette = "Fall", limits=c(-1,1)) +
      # scale_fill_viridis(option = "viridis",limits=c(0,0.8)) +
      # scale_colour_viridis(option = "viridis",limits=c(0,0.8)) +
    facet_rep_grid(Fishing_ID~Id) +
    coord_capped_cart(bottom='both', left='both') +
    theme(strip.text.x = element_text(size = 11)) + 
    theme(strip.text.y = element_text(size = 11,angle = 0))

dev.off()

```




```{r}

```






